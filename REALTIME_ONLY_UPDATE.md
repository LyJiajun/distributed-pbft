# 仅使用真实会话数据 - 更新说明

## 🎯 修改目标

根据用户需求，进行以下修改：
1. ❌ **移除所有模拟数据** - 只使用真实会话的实际消息
2. ❌ **移除自动删除会话逻辑** - 创建新会话时不再删除旧会话
3. ✅ **只展示真实通信数据** - 每个小球代表真实发送的消息

## 📝 修改内容

### 1. HomePage.vue - 前端修改

#### 移除模拟数据生成逻辑
```javascript
// ❌ 删除了
// - 生成3轮模拟数据的代码
// - /api/simulate API调用
// - 模拟演示模式的所有逻辑

// ✅ 保留
// - 只获取真实会话历史
// - 必须先创建会话才能查看动画
```

#### 修改 `showDemo` 函数
**之前**：
- 如果有会话：获取真实历史
- 如果没有会话：生成3轮模拟数据
- 会话获取失败：降级到模拟数据

**现在**：
```javascript
const showDemo = async () => {
  // 1. 检查是否已创建会话
  if (!sessionInfo.value) {
    ElMessage.error('请先创建共识会话！')
    return
  }
  
  // 2. 只获取真实会话历史
  const response = await axios.get(`/api/sessions/${sessionInfo.value.sessionId}/history`)
  
  // 3. 展示真实数据
  simulationRounds.value.push({
    id: 1,
    data: response.data,
    isReal: true
  })
  
  // 4. 播放动画
  demoDialogVisible.value = true
  playAnimation()
}
```

#### 移除自动删除会话逻辑
**之前**：
```javascript
const createSession = async () => {
  // 如果已有会话，先废弃之前的会话
  if (sessionInfo.value) {
    await axios.delete(`/api/sessions/${sessionInfo.value.sessionId}`)
  }
  // 创建新会话...
}
```

**现在**：
```javascript
const createSession = async () => {
  // 直接创建新会话，不删除旧会话
  const response = await axios.post('/api/sessions', {...})
  sessionInfo.value = response.data
}
```

#### 简化界面
**之前**：
- 轮次选择器（第1/2/3轮）
- 模式标签（真实/模拟）

**现在**：
```html
<div class="round-selector">
  <el-tag type="success">真实会话消息历史</el-tag>
  <el-text>展示会话中实际发送的消息</el-text>
  <el-button @click="playAnimation">重新播放动画</el-button>
</div>
```

#### 移除不需要的函数和变量
```javascript
// ❌ 删除了
// - onRoundChange() - 轮次切换函数
// - 模拟数据相关的所有代码

// ✅ 保留
// - showDemo() - 只获取真实历史
// - playAnimation() - 播放动画
```

### 2. backend/main.py - 后端修改

#### 移除模拟API
```python
# ❌ 完全删除了 /api/simulate 接口
# 包括：
# - 模拟数据生成逻辑
# - 拜占庭节点模拟
# - 消息模拟算法
```

#### 保留真实历史API
```python
# ✅ 保留 /api/sessions/{session_id}/history
@app.get("/api/sessions/{session_id}/history")
async def get_session_history(session_id: str):
    """获取会话的真实消息历史，用于动画演示"""
    # 1. 从会话中读取实际发送的消息
    # 2. 将广播消息展开为点对点消息
    # 3. 根据拓扑结构过滤
    # 4. 返回真实数据
```

## 🎨 用户体验

### 使用流程

#### 步骤1：创建会话
```
用户：点击"创建共识会话"
系统：创建新会话（不删除旧会话）
结果：✅ 会话创建成功
```

#### 步骤2：参与共识
```
用户：扫描二维码，加入节点
用户：发送准备/提交消息
系统：记录所有实际发送的消息
```

#### 步骤3：查看动画
```
用户：点击"动画演示共识过程"
系统：检查是否有会话 ✅
系统：获取真实消息历史
系统：播放动画（只显示实际发送的消息）
```

### 错误处理

#### 场景1：未创建会话
```
用户：点击"动画演示"按钮
系统：❌ 请先创建共识会话！
```

#### 场景2：会话已过期
```
用户：点击"动画演示"按钮
系统：❌ 会话不存在或已过期，请重新创建会话
```

#### 场景3：网络错误
```
用户：点击"动画演示"按钮
系统：❌ 获取会话历史失败，请稍后重试
```

## 📊 动画显示规则

### 真实消息展示
```
Pre-Prepare阶段:
  ✓ 节点0发送提议 → 显示动画（如果真的发送了）
  
Prepare阶段:
  ✓ 节点0发送 → 显示绿色动画（正确值）
  ✓ 节点1发送 → 显示绿色动画
  ✗ 节点2未发送 → 不显示任何动画
  ✓ 节点3发送错误值 → 显示红色动画（拜占庭攻击）
  ✓ 节点4发送 → 显示绿色动画
  
Commit阶段:
  ✓ 只显示实际发送的提交消息
  ✗ 没有发送的节点不会显示
```

### 颜色规则
- 🟢 **绿色消息**：`message.value === proposalValue`（正确）
- 🔴 **红色消息**：`message.value !== proposalValue`（拜占庭攻击）

### 拓扑结构
- 根据设置的拓扑结构过滤连接
- 只显示拓扑允许的消息路径
- 例如：环形拓扑中只显示相邻节点间的消息

## ✅ 优势

### 1. 真实性
- ✅ 100%真实数据
- ✅ 准确反映实际行为
- ✅ 可以看到人类节点是否真的参与

### 2. 教学价值
- ✅ 观察真实的拜占庭攻击
- ✅ 看到节点未响应的情况
- ✅ 理解实际共识过程的挑战

### 3. 调试价值
- ✅ 验证消息是否真的发送了
- ✅ 检查拜占庭节点的行为
- ✅ 分析共识失败的原因

### 4. 简洁性
- ✅ 移除了复杂的模拟逻辑
- ✅ 代码更简单易维护
- ✅ 界面更清晰

## 🔍 对比

### 修改前
| 特性 | 说明 |
|------|------|
| 数据来源 | 真实会话 + 模拟数据 |
| 会话管理 | 创建新会话时删除旧会话 |
| 轮次 | 真实1轮 + 模拟3轮 |
| 复杂度 | 较高（两套逻辑） |
| 用户体验 | 可能混淆真实和模拟 |

### 修改后
| 特性 | 说明 |
|------|------|
| 数据来源 | **仅真实会话** |
| 会话管理 | **不删除旧会话** |
| 轮次 | **仅1轮真实数据** |
| 复杂度 | **简单（单一逻辑）** |
| 用户体验 | **明确是真实数据** |

## 🚀 使用示例

### 完整流程示例

```bash
# 1. 创建会话
用户A: 配置参数（6个节点，1个拜占庭节点）
用户A: 点击"创建共识会话"
✅ 会话创建成功

# 2. 加入节点
用户B: 扫描二维码，加入节点1
用户C: 扫描二维码，加入节点2（选择拜占庭攻击）
用户D: 扫描二维码，加入节点3
...（其余节点由机器人自动补齐）

# 3. 参与共识
- 节点0（机器人）发送提议
- 节点1（用户B）发送准备消息 ✅
- 节点2（用户C）发送错误的准备消息 🔴
- 节点3（用户D）忘记点击，未发送 ✗
- 其他机器人节点正常发送 ✅

# 4. 查看动画
用户A: 点击"动画演示共识过程"
系统显示:
  ✅ 标签："真实会话消息历史"
  ✅ 提示："展示会话中实际发送的消息"
  
动画播放:
  🟢 节点0→其他：提议消息（绿色）
  🟢 节点1→其他：准备消息（绿色，正确值）
  🔴 节点2→其他：准备消息（红色，拜占庭攻击）
  ⚫ 节点3：没有动画（未发送）
  🟢 节点4,5：准备消息（绿色）
  ...（提交阶段同理）
```

## 📋 修改的文件

### 前端
- ✅ `/src/views/HomePage.vue`
  - 移除模拟数据生成
  - 移除自动删除会话逻辑
  - 简化界面和逻辑
  - 移除onRoundChange函数

### 后端
- ✅ `/backend/main.py`
  - 删除 `/api/simulate` 接口
  - 保留 `/api/sessions/{session_id}/history` 接口

### 文档
- ✅ `REALTIME_ONLY_UPDATE.md` - 本文档

## 🎯 注意事项

### 使用前提
1. **必须先创建会话**：点击动画演示前必须创建会话
2. **必须有消息**：如果所有节点都没发送消息，动画会是空的
3. **网络稳定**：确保能获取到会话历史数据

### 预期行为
- ✅ 只显示实际发送的消息
- ✅ 拜占庭攻击的错误消息显示为红色
- ✅ 未发送的消息不会显示
- ✅ 机器人节点按规则自动发送

### 不再支持
- ❌ 不再有模拟演示模式
- ❌ 不再有多轮次切换
- ❌ 不再自动生成理想的共识过程
- ❌ 不再在创建新会话时删除旧会话

## 🔄 迁移指南

### 如果之前使用了模拟模式
**之前的工作流**：
1. 不创建会话
2. 直接点击"动画演示"
3. 查看3轮模拟数据

**现在的工作流**：
1. **必须创建会话**
2. 让节点参与共识
3. 点击"动画演示"
4. 查看真实消息历史

## ✅ 测试检查清单

- [ ] 创建会话不会删除旧会话
- [ ] 未创建会话时点击动画，显示错误提示
- [ ] 创建会话后点击动画，正常显示
- [ ] 只显示实际发送的消息
- [ ] 拜占庭攻击的消息显示为红色
- [ ] 未发送消息的节点不显示动画
- [ ] 重新播放按钮正常工作
- [ ] 会话不存在时显示友好错误

---

**更新日期**：2025-11-02  
**版本**：3.0.0  
**类型**：重大更新 - 移除模拟功能

