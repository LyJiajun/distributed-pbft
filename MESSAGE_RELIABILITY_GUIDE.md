# 消息可靠性控制功能使用指南

## 功能概述

消息可靠性控制功能允许每个节点（特别是人类用户节点）精细控制发送给其他节点的消息到达概率。这个功能可以用来模拟网络不稳定、丢包、节点间通信故障等真实场景。

## 功能特点

✨ **节点级别控制**: 每个节点可以独立设置发送给其他每个节点的消息可靠性

✨ **灵活的概率设置**: 支持 0%-100% 的任意概率（步长 5%）

✨ **快速设置**: 提供一键设置所有节点可靠性的快捷按钮

✨ **实时生效**: 配置更改后立即生效，无需重启

✨ **可视化矩阵**: 直观的滑块界面，清晰展示每个目标节点的可靠性

## 使用方法

### 1. 进入节点页面

1. 创建一个共识会话
2. 扫描二维码或点击链接加入为一个节点
3. 等待新一轮共识开始

### 2. 激活可靠性控制

1. 在节点页面，选择 **"拜占庭攻击"** 模式
2. 向下滚动到 **"📡 消息可靠性控制"** 部分
3. 点击 **"显示可靠性矩阵"** 按钮

### 3. 调整可靠性设置

#### 方式一：快速设置（批量操作）

使用快速设置按钮一键设置所有节点的可靠性：
- **100%**: 所有消息都能到达（默认设置）
- **75%**: 75% 的消息能到达，25% 丢失
- **50%**: 一半消息能到达，模拟严重网络问题
- **0%**: 完全阻断与所有节点的通信

#### 方式二：单独调整（精细控制）

为每个目标节点单独设置可靠性：
1. 找到要调整的目标节点（例如 "→ 节点3"）
2. 拖动滑块调整可靠性百分比
3. 右侧会实时显示当前设置的值
4. 松开滑块后，配置自动发送到后端

### 4. 发送消息

配置完成后，当你发送消息时（准备消息或提交消息），系统会：
1. 对每个目标节点单独判断
2. 根据设置的概率随机决定是否发送
3. 在后端日志中记录发送/丢弃的消息

## 应用场景

### 场景 1: 模拟网络分区

**目标**: 模拟节点之间的网络分区（某些节点无法相互通信）

**设置**:
- 节点 2 → 节点 0: 0%（完全隔离）
- 节点 2 → 节点 1: 0%（完全隔离）
- 节点 2 → 节点 3: 100%（正常）
- 节点 2 → 节点 4: 100%（正常）

**效果**: 节点 2 只能与节点 3、4 通信，形成一个网络分区

### 场景 2: 模拟不稳定网络

**目标**: 模拟一个网络不稳定的节点

**设置**:
- 所有目标节点设置为 50-70%

**效果**: 约一半的消息会丢失，模拟网络质量差的情况

### 场景 3: 模拟选择性攻击

**目标**: 针对特定节点进行攻击，只阻断与该节点的通信

**设置**:
- 节点 2 → 节点 0: 0%（攻击目标）
- 节点 2 → 其他节点: 100%（正常）

**效果**: 只有节点 0 收不到节点 2 的消息

### 场景 4: 测试 PBFT 容错能力

**目标**: 验证 PBFT 算法在部分消息丢失情况下仍能达成共识

**设置**:
- 随机设置某些连接为 70-90%
- 确保整体有足够的消息能到达

**效果**: 即使有消息丢失，诚实节点仍能达成共识

## 技术实现

### 前端实现

**数据结构**:
```javascript
reliabilityConfig = {
  "0": 100,  // 到节点0的可靠性
  "1": 75,   // 到节点1的可靠性
  "3": 50,   // 到节点3的可靠性
  "4": 0     // 到节点4的可靠性（完全阻断）
}
```

**通信机制**:
```javascript
// 当用户调整滑块时，通过 Socket.IO 发送配置
socket.emit('update_reliability', {
  sessionId: sessionId,
  nodeId: nodeId,
  reliability: reliabilityConfig
})
```

### 后端实现

**存储结构**:
```python
node_reliability = {
  "session_id": {
    node_id: {
      target_node_id: percentage
    }
  }
}
```

**消息过滤逻辑**:
```python
def should_deliver_message(session_id, from_node, to_node):
    # 优先检查节点级别配置
    if from_node and to_node:
        reliability = node_reliability[session_id][from_node][to_node]
        return random.random() * 100 < reliability
    
    # 否则使用全局配置
    return random.random() * 100 < global_delivery_rate
```

**消息发送**:
- 不再广播消息，而是为每个目标节点单独发送
- 每个目标节点都经过独立的可靠性判断
- 只有通过判断的消息才会发送给目标节点

## 与全局消息可靠性的关系

系统同时支持两种可靠性控制方式：

### 1. 全局消息可靠性（原有功能）
- 在创建会话时设置 `messageDeliveryRate`
- 应用于所有节点的所有消息
- 简单但不够灵活

### 2. 节点级别可靠性（新功能）
- 每个节点单独配置
- 可以精细控制每个连接
- 优先级高于全局设置

**优先级规则**:
```
节点级别配置 > 全局配置
```

如果节点设置了到某个目标的可靠性，使用节点配置；否则使用全局配置。

## 调试和监控

### 后端日志

后端会记录详细的消息发送/丢弃日志：

```
节点 2 的准备消息已发送给节点 0
节点 2 到节点 1 的准备消息被丢弃（可靠性设置）
节点 2 的准备消息已发送给节点 3
节点 2 到节点 4 的准备消息被丢弃（可靠性设置）
```

### 前端观察

在节点页面可以观察：
1. **收到的消息列表**: 实际收到了哪些消息
2. **网络拓扑图**: 哪些节点活跃、有消息
3. **共识进度**: 可靠性设置对共识的影响

## 注意事项

⚠️ **仅对人类节点生效**: 机器人节点之间的通信不受此设置影响

⚠️ **可能导致共识失败**: 如果可靠性设置过低，可能导致节点收不到足够的消息，共识失败

⚠️ **实时生效**: 配置更改后立即生效，当前阶段的消息就会应用新配置

⚠️ **不影响历史消息**: 只影响配置后发送的新消息

## 常见问题

### Q: 为什么我设置了 0% 但还能看到消息？
A: 可能是其他节点发送的消息。你设置的 0% 只影响 **你发送给该节点** 的消息，不影响接收。

### Q: 如何完全隔离两个节点？
A: 两个节点都需要将对方的可靠性设置为 0%。

### Q: 可靠性设置会影响共识结果吗？
A: 会的。如果太多消息丢失，可能导致节点收不到足够的消息（2f+1），从而共识失败或超时。

### Q: 如何重置所有设置？
A: 点击 "100%" 快速设置按钮，或刷新页面重新加入。

### Q: 可靠性设置会保存吗？
A: 不会。设置只在当前会话有效，刷新页面后恢复默认（100%）。

## 未来改进

可能的功能增强：

- [ ] 保存和加载可靠性配置预设
- [ ] 可视化显示消息到达情况（成功/失败）
- [ ] 统计实际消息到达率
- [ ] 支持时间变化的动态可靠性（模拟网络波动）
- [ ] 支持双向可靠性设置（同时设置发送和接收）

## 总结

消息可靠性控制功能为 PBFT 共识系统提供了强大的网络模拟能力，使得用户可以：

✅ 深入理解 PBFT 的容错机制  
✅ 测试各种网络故障场景  
✅ 验证共识算法的健壮性  
✅ 进行更真实的分布式系统实验  

这个功能特别适合用于教学演示和算法验证，帮助学习者理解分布式系统中的通信挑战。






