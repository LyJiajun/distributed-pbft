# PBFT共识动画演示功能使用指南

## 功能概述

在主界面（HomePage）新增了一个"动画演示共识过程"按钮，可以通过动画可视化展示PBFT共识算法的完整过程，帮助用户直观理解共识机制。

## 功能特性

### 1. 真实会话历史回放 ⭐ 新功能
- **真实消息展示**：显示会话中实际发送的消息
- **人类节点行为**：准确反映人类节点是否发送了消息
- **拜占庭攻击可视化**：如果人类节点发送了错误消息，用红色圆圈标记
- **机器人节点行为**：展示机器人节点按规则发送的消息
- **只展示实际发送的消息**：如果节点没有发送消息，就不会显示

### 2. 动画演示
- **拓扑图可视化**：在Canvas上绘制节点网络拓扑
- **消息传递动画**：动态展示消息在节点间的传递过程
- **三阶段展示**：依次播放Pre-Prepare、Prepare、Commit三个阶段
- **智能颜色区分**：
  - 绿色节点：诚实节点
  - 红色节点：拜占庭节点
  - 绿色消息点：与提议值相同（正确消息）
  - 红色消息点：与提议值不同（拜占庭攻击）

### 3. 两种演示模式
- **真实会话模式**：如果已创建会话，显示真实的消息历史
- **模拟演示模式**：如果未创建会话，自动生成3轮模拟数据
- 界面会清楚标记当前是哪种模式

### 4. 详细数据表格
- 展示每个节点在各阶段发送的消息
- 标记消息的正确性（AGREE/ARBITRARY）
- 显示最终共识结果

## 使用步骤

### 第一步：配置参数

在主界面配置共识参数：
- **总节点数**：3-20个节点（建议6个）
- **故障节点数**：拜占庭节点数量（建议1个）
- **拓扑结构**：全连接、环形、星形或树形
- **提议值**：0或1
- **恶意提议者**：是否启用恶意提议者
- **允许消息篡改**：是否允许拜占庭节点篡改消息

### 第二步：启动演示

点击"动画演示共识过程"按钮：

#### 场景A：已创建会话（真实模式）
1. 系统检测到已有会话
2. 从后端获取会话的真实消息历史
3. 弹出演示对话框，标记为"真实会话消息历史"
4. 自动播放真实消息的动画
5. **只显示实际发送的消息**：
   - 人类节点发送的消息会显示
   - 人类节点未发送的消息不会显示
   - 拜占庭攻击的错误消息用红色标记

#### 场景B：未创建会话（模拟模式）
1. 系统验证参数配置
2. 调用后端API生成3轮模拟数据
3. 弹出演示对话框，标记为"模拟演示数据"
4. 自动播放第1轮的模拟动画
5. 可切换查看不同轮次

### 第三步：查看动画

演示对话框包含：
- **轮次选择器**：切换查看不同轮次
- **拓扑图区域**：显示网络拓扑和消息传递动画
- **消息表格**：详细的消息发送记录
- **重新播放按钮**：重新播放当前轮次的动画

### 第四步：切换轮次

- 点击"第1轮"、"第2轮"、"第3轮"按钮
- 系统自动加载对应轮次的数据
- 自动播放新轮次的动画
- 可随时点击"重新播放动画"按钮

## 技术实现

### 前端组件

#### HomePage.vue 修改
- 添加"动画演示共识过程"按钮
- 集成Topology.vue和PBFTTable.vue组件
- 实现真实会话历史获取逻辑
- 实现模拟数据生成逻辑
- 智能判断使用哪种模式
- 实现轮次选择和切换逻辑
- 添加演示对话框UI

#### 复制的组件
- **Topology.vue**：Canvas动画组件，绘制拓扑图和消息传递
- **PBFTTable.vue**：消息详情表格组件

### 后端API

#### `/api/sessions/{session_id}/history` (GET)
获取真实会话的消息历史记录

**功能**：
- 读取会话中实际发送的消息
- 将广播消息展开为点对点消息（适配动画）
- 根据拓扑结构过滤连接关系
- 保留消息的真实value（用于显示拜占庭攻击）

**响应数据**：
```json
{
  "pre_prepare": [...],
  "prepare": [[...]],
  "commit": [[...]],
  "consensus": "共识成功：达成共识值 0",
  "messages": [...],
  "nodeCount": 6,
  "topology": "full",
  "proposalValue": 0
}
```

#### `/api/simulate` (POST)
生成PBFT共识模拟数据的接口

**请求参数**：
```json
{
  "nodeCount": 6,
  "faultyNodes": 1,
  "robotNodes": 5,
  "topology": "full",
  "branchCount": 2,
  "proposalValue": 0,
  "proposalContent": "",
  "maliciousProposer": false,
  "allowTampering": false,
  "messageDeliveryRate": 100
}
```

**响应数据**：
```json
{
  "pre_prepare": [...],
  "prepare": [[...]],
  "commit": [[...]],
  "consensus": "共识成功：达成共识值 0",
  "messages": [...],
  "nodeCount": 6,
  "topology": "full"
}
```

## 动画流程

### 1. Pre-Prepare阶段
- 提议者（节点0）向所有节点发送提议值
- 动画显示消息从节点0飞向其他节点
- 根据拓扑结构决定消息路径

### 2. Prepare阶段
- 每个节点向其他节点广播准备消息
- 所有消息同时播放动画
- 拜占庭节点可能发送错误值（红色）

### 3. Commit阶段
- 每个节点向其他节点广播提交消息
- 所有消息同时播放动画
- 完成后显示共识结果

## 对比不同模式

### 真实会话历史 vs 模拟演示 vs 真实交互

| 特性 | 真实会话历史 | 模拟演示 | 真实交互 |
|------|------------|---------|---------|
| 用途 | 回放真实消息 | 教学演示 | 多人参与共识 |
| 数据来源 | 会话真实消息记录 | 算法自动生成 | 用户实时操作 |
| 消息准确性 | 100%真实 | 模拟理想情况 | 真实行为 |
| 人类节点 | 显示实际发送的消息 | 假设都发送 | 手动发送消息 |
| 拜占庭攻击 | 真实攻击行为 | 模拟攻击 | 用户选择攻击 |
| 交互方式 | 观看回放 | 观看动画 | 参与操作 |
| 轮次 | 1轮（当前会话） | 3轮模拟 | 可多轮 |

## 使用场景

### 教学演示
- 向学生展示PBFT算法原理
- 直观理解三阶段共识过程
- 观察拜占庭节点的影响

### 参数测试
- 快速测试不同参数配置
- 观察不同拓扑结构的消息路径
- 验证容错机制

### 概念理解
- 理解消息传递过程
- 观察共识达成条件
- 学习拜占庭容错原理

## 注意事项

1. **参数配置必须有效**：演示前会验证参数配置的正确性
2. **动画速度固定**：动画速度在Topology.vue中设置为100步
3. **轮次独立性**：每轮的拜占庭节点行为是独立随机的
4. **浏览器性能**：节点数过多（>15）可能影响动画流畅度

## 文件清单

### 新增文件
- `/src/components/Topology.vue` - 拓扑动画组件
- `/src/components/PBFTTable.vue` - 消息表格组件

### 修改文件
- `/src/views/HomePage.vue` - 主界面（添加演示功能）
- `/backend/main.py` - 后端（添加模拟API）

## 扩展建议

### 未来可以添加的功能
1. **动画速度控制**：添加快进、慢放、暂停功能
2. **步进模式**：逐步播放每条消息
3. **消息高亮**：点击节点高亮相关消息
4. **历史记录**：保存和导出演示数据
5. **更多轮次**：支持自定义轮次数量
6. **导出视频**：录制动画并导出为视频

## 故障排查

### 常见问题

**Q: 点击按钮没有反应？**
A: 检查参数配置是否有效，查看浏览器控制台错误信息

**Q: 动画没有播放？**
A: 等待对话框完全打开后（约300ms），动画会自动播放

**Q: 切换轮次时动画卡住？**
A: 可能是浏览器性能问题，尝试减少节点数量

**Q: 后端报错？**
A: 确保后端服务正常运行，检查`/api/simulate`接口是否可访问

## 开发者信息

- **前端框架**：Vue 3 + Element Plus
- **动画技术**：Canvas 2D API
- **后端框架**：FastAPI
- **通信协议**：HTTP REST API

---

**版本**：1.0.0  
**更新日期**：2025-11-01  
**作者**：分布式PBFT共识系统团队


