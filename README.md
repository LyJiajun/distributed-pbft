# 分布式PBFT共识系统

一个基于PBFT（Practical Byzantine Fault Tolerance）算法的分布式共识系统，允许真实用户扮演节点参与共识过程。

## 功能特点

- 🎯 **真实节点参与**: 用户可以通过扫描二维码或直接访问链接扮演具体节点
- 🔄 **实时通信**: 基于WebSocket的实时节点间通信
- 📊 **可视化界面**: 直观的节点状态、消息流和共识进度展示
- 🎮 **交互式操作**: 用户可以在适当时机发送准备和提交消息
- 📱 **移动友好**: 支持移动设备访问，便于多人参与
- 👥 **用户友好**: 节点界面针对非专业用户进行了简化

## 系统架构

### 前端 (Vue 3 + Element Plus)
- **主控页面**: 配置共识参数，生成二维码（保留专业术语）
- **节点页面**: 用户扮演具体节点参与共识（简化界面，适合非专业用户）
- **实时通信**: Socket.IO客户端

### 后端 (FastAPI + Socket.IO)
- **会话管理**: 创建和管理共识会话
- **WebSocket服务**: 处理节点间实时通信
- **PBFT算法**: 实现三阶段共识过程

## 快速开始

### 1. 安装依赖

```bash
# 前端依赖
npm install

# 后端依赖
cd backend
pip install -r requirements.txt
cd ..
```

### 2. 启动服务

#### 方法一：使用启动脚本（推荐）
```bash
chmod +x start.sh
./start.sh
```

#### 方法二：手动启动
```bash
# 启动后端服务
cd backend
python main.py

# 启动前端服务（新终端）
npm run dev
```

### 3. 使用系统

1. **创建会话**: 访问 `http://localhost:3000`，配置共识参数并创建会话
2. **生成二维码**: 系统会自动生成二维码，供其他用户扫描
3. **加入节点**: 其他用户扫描二维码或访问节点链接加入共识
4. **参与共识**: 用户扮演节点，在简化的界面中参与共识过程

**注意**: 确保后端服务在 `http://localhost:8000` 运行，前端服务在 `http://localhost:3000` 运行。

### 4. 测试系统

```bash
# 测试后端API
python test_backend.py
```

## 共识流程

### 三阶段PBFT算法

1. **预准备阶段 (Pre-Prepare)**
   - 提议者（节点0）向所有节点发送提议值
   - 其他节点接收并验证提议

2. **准备阶段 (Prepare)**
   - 每个节点向其他节点发送准备消息
   - 节点收集足够多的准备消息后进入下一阶段

3. **提交阶段 (Commit)**
   - 每个节点向其他节点发送提交消息
   - 节点收集足够多的提交消息后执行提议

### 容错机制

- 所有节点都可以选择成为拜占庭节点
- 支持恶意提议者和消息篡改场景
- 用户自主选择是否进行拜占庭攻击

## 配置参数

- **节点总数**: 参与共识的节点数量（3-20个）
- **容错节点数**: 所有节点都可以选择成为拜占庭节点
- **拓扑结构**: 节点间连接方式（全连接、环形、星形、树形）
- **提议值**: 共识的目标值（0或1）
- **恶意提议者**: 是否启用恶意提议者模式
- **允许消息篡改**: 是否允许故障节点篡改消息

## 可靠性实验（p-成功率曲线）

本项目内置“通信可靠性实验”，用于观察在**点对点独立链路模型**下，链路成功概率 \(p\) 对 PBFT 共识成功率的影响，并在同一张图中对照：
- **实验值**：后端 Monte-Carlo 批量运行多轮共识得到的成功率
- **理论值**：后端按 Theorem 1（式(1)–(6)）特例化后的精确枚举计算结果（虚线）

### 实验口径（与后端实现保持一致）

- **链路模型**：任意两节点间每条消息独立以概率 \(p\) 成功送达（全局由 `messageDeliveryRate` 控制，范围 0–100%）
- **阶段门限（单节点）**：prepare/commit 阶段要求“来自其他节点”的成功消息数 \(\ge 2f\)
- **最终成功判据（口径A）**：commit 成功节点数 \(N_c \ge N - f\)
- **容错参数**：默认 \(f=\lfloor (N-1)/3 \rfloor\)

### 怎么跑实验

1. 启动后端与前端（见“快速开始”），访问 `http://localhost:3000`
2. 进入 **Experiment** 页面（侧边栏切换）
3. 设置：
   - `nodeCount`（节点数）
   - `messageDeliveryRate`（可靠性 p，对应百分比）
   - `rounds`（每个 p 取值下的实验轮数）
4. 点击开始实验后，前端会调用后端批量接口运行所有轮次并汇总结果

### 后端批量接口与返回字段

- **接口**：`POST /api/sessions/{session_id}/run-batch-experiment?rounds=30`
- **返回**（核心字段）：
  - `experimentalSuccessRate`：实验成功率（百分比）
  - `theoreticalSuccessRate`：理论成功率（百分比）
  - `results`：每轮成功/失败与消息统计

> 注意：如果你修改了后端逻辑（尤其是实验/判定相关），请**重启后端**，否则前端仍会连接旧进程导致曲线看起来“不对齐”。

## 节点界面简化

为了适应非专业用户，节点界面进行了以下简化：

### 保留的核心功能
- ✅ **共识进度**: 实时显示共识的四个阶段（提议、准备、确认、完成）
- ✅ **收到的消息**: 查看来自其他参与者的消息
- ✅ **网络拓扑图**: 可视化显示参与者之间的连接关系
- ✅ **共识结果**: 展示最终的共识结果和统计信息

### 简化的术语
- "节点" → "参与者"
- "预准备/准备/提交" → "提议/准备/确认"
- "提议值" → "提议内容"
- "拓扑结构" → "网络类型"

### 移除的复杂功能
- 复杂的攻击控制面板
- 详细的消息发送表单
- 专业的技术参数配置

## 技术栈

### 前端
- Vue 3 (Composition API)
- Vue Router
- Element Plus UI
- Socket.IO Client
- QRCode.js

### 后端
- FastAPI
- Python Socket.IO
- Pydantic
- Uvicorn

## 项目结构

```
distributed-pbft/
├── src/
│   ├── views/
│   │   ├── HomePage.vue      # 主控页面（保留专业术语）
│   │   ├── JoinPage.vue      # 加入页面（保留专业术语）
│   │   └── NodePage.vue      # 节点页面（简化界面）
│   ├── App.vue
│   └── main.js
├── backend/
│   ├── main.py              # 后端服务器
│   └── requirements.txt     # Python依赖
├── package.json
├── vite.config.js
└── README.md
```

## 使用场景

- **教学演示**: 区块链和分布式系统课程
- **团队协作**: 多人参与的共识决策
- **技术研究**: PBFT算法实验和验证
- **概念验证**: 分布式系统原型开发

## 开发计划

- [ ] 支持更多共识算法（Raft、Paxos等）
- [ ] 添加网络延迟和丢包模拟
- [ ] 实现更复杂的恶意行为模式
- [ ] 添加历史记录和回放功能
- [ ] 支持自定义消息格式

## 贡献

欢迎提交Issue和Pull Request来改进这个项目！

## 许可证

MIT License 